# Example: Using Discovered URLs in Tests

This example shows how to use the URL discovery tool to generate test cases that can be imported into `test_real_urls.py`.

## Quick Start

### Step 1: Discover URLs

Run the discovery tool with verified starting URLs:

```bash
pipenv run python tools/discover_substack_urls.py --use-defaults --test-output tests/discovered_test_urls.py
```

This will create `tests/discovered_test_urls.py` with content like:

```python
# Auto-discovered Substack URLs for testing
# Generated by tools/discover_substack_urls.py
# Import in test_real_urls.py with: from discovered_test_urls import DISCOVERED_TEST_CASES

DISCOVERED_TEST_CASES = [
    (
        "https://astralcodexten.substack.com/p/example-post",
        None,
        "Discovered regular post",
    ),
    (
        "https://substack.com/@contraptions/note/c-191022428",
        "note",
        "Discovered note",
    ),
    (
        "https://substack.com/chat/9973/post/64cc3fbb-ef7b-44a8-b8a9-9e336cc7e71b",
        "chat",
        "Discovered chat",
    ),
]

# Raw URLs by type (for compatibility)
DISCOVERED_TEST_URLS = {
    "posts": [...],
    "notes": [...],
    "chats": [...],
}
```

### Step 2: Enable in Tests

Edit `tests/test_real_urls.py` and uncomment these lines:

```python
# Uncomment to use auto-discovered test cases:
try:
    from discovered_test_urls import DISCOVERED_TEST_CASES
    USE_DISCOVERED = True
except ImportError:
    DISCOVERED_TEST_CASES = []
    USE_DISCOVERED = False
```

And this section:

```python
# Add discovered test cases if available
if USE_DISCOVERED:
    print(f"\nAdding {len(DISCOVERED_TEST_CASES)} auto-discovered test cases")
    test_cases.extend(DISCOVERED_TEST_CASES)
```

### Step 3: Run Tests

```bash
pipenv run python tests/test_real_urls.py
```

Output will show:
```
Testing URL Pattern Detection
================================================================================
Adding 5 auto-discovered test cases

✓ Regular Substack post
  URL: https://astralcodexten.substack.com/p/ai-sleeper-agents
  Expected: None, Got: None

... (11 manually defined tests)

✓ Discovered regular post
  URL: https://astralcodexten.substack.com/p/example-post
  Expected: None, Got: None

... (5 auto-discovered tests)

================================================================================
Results: 16 passed, 0 failed
```

## Format Details

### Test Case Format

Each test case is a tuple with three elements:

```python
(
    "URL_STRING",           # The URL to test
    "EXPECTED_TYPE",        # Expected content type: None, "note", or "chat"
    "DESCRIPTION",          # Human-readable description
)
```

### Compatibility Format

The tool also generates a dictionary format for backward compatibility:

```python
DISCOVERED_TEST_URLS = {
    "posts": [list of post URLs],
    "notes": [list of note URLs],
    "chats": [list of chat URLs],
}
```

This can be used in custom test scripts:

```python
from discovered_test_urls import DISCOVERED_TEST_URLS

for post_url in DISCOVERED_TEST_URLS["posts"]:
    # Test post detection
    assert get_substack_content_type(post_url) is None
```

## Advanced Usage

### Customize Discovery

You can customize what gets discovered:

```bash
# Discover more content
pipenv run python tools/discover_substack_urls.py \
    --use-defaults \
    --domains 5 \
    --posts 3 \
    --notes 5 \
    --chats 3 \
    --test-output tests/discovered_test_urls.py
```

### Use Both Formats

You can use both test case format and raw URLs:

```python
from discovered_test_urls import DISCOVERED_TEST_CASES, DISCOVERED_TEST_URLS

# Use in parameterized tests
for url, expected, desc in DISCOVERED_TEST_CASES:
    result = get_substack_content_type(url)
    assert result == expected, f"Failed: {desc}"

# Or use raw URLs for specific tests
for note_url in DISCOVERED_TEST_URLS["notes"]:
    assert get_substack_content_type(note_url) == "note"
```

## Benefits

1. **Automatic test expansion**: Easily add more test cases without manual editing
2. **Real-world URLs**: Tests use actual Substack content
3. **Verified starting points**: Default URLs are known to work
4. **Easy updates**: Re-run discovery tool to get fresh URLs
5. **Consistent format**: Generated code matches manual test cases exactly

## Notes

- The discovery tool requires internet access
- Rate limiting is enabled by default (1 second between requests)
- Generated file should be reviewed before committing
- Consider using `--use-defaults` for best results
